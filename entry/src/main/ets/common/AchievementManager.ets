import { DatabaseManager } from './DatabaseManager'
import { AchievementModel } from './models/AchievementModel'

export class AchievementManager {
  private static instance: AchievementManager
  private databaseManager: DatabaseManager

  private constructor() {
    this.databaseManager = DatabaseManager.getInstance()
  }

  static getInstance(): AchievementManager {
    if (!AchievementManager.instance) {
      AchievementManager.instance = new AchievementManager()
    }
    return AchievementManager.instance
  }

  // åˆå§‹åŒ–é»˜è®¤æˆå°±åˆ°æ•°æ®åº“
  async initializeDefaultAchievements(): Promise<void> {
    try {
      const existingAchievements = await this.databaseManager.getAllAchievements()
      if (existingAchievements.length === 0) {
        const defaultAchievements = this.getDefaultAchievements()
        for (const achievement of defaultAchievements) {
          await this.databaseManager.addAchievement(achievement)
        }
        console.info('é»˜è®¤æˆå°±åˆå§‹åŒ–å®Œæˆ')
      }
    } catch (error) {
      console.error('åˆå§‹åŒ–é»˜è®¤æˆå°±å¤±è´¥:', error)
    }
  }

  // æ£€æŸ¥å¹¶æ›´æ–°æˆå°±è¿›åº¦
  async checkAndUpdateAchievements(): Promise<void> {
    try {
      const userStats = await this.databaseManager.getUserStats()
      const examRecords = await this.databaseManager.getExamRecords()
      const achievements = await this.databaseManager.getAllAchievements()
      
      console.info('æˆå°±æ£€æŸ¥ - ç”¨æˆ·ç»Ÿè®¡:', JSON.stringify(userStats))
      console.info('æˆå°±æ£€æŸ¥ - è€ƒè¯•è®°å½•æ•°é‡:', examRecords.length)
      console.info('æˆå°±æ£€æŸ¥ - æˆå°±æ•°é‡:', achievements.length)

      for (const achievement of achievements) {
        console.info(`æ£€æŸ¥æˆå°± ${achievement.id}: æ ‡é¢˜=${achievement.title}, å·²è§£é”=${achievement.isUnlocked}, è¿›åº¦=${achievement.progress}/${achievement.maxProgress}`)
        
        if (achievement.isUnlocked) {
          console.info(`æˆå°± ${achievement.id} å·²è§£é”ï¼Œè·³è¿‡æ£€æŸ¥`)
          continue
        }

        let shouldUpdate = false
        let newProgress = achievement.progress

        console.info(`å¼€å§‹æ£€æŸ¥æˆå°±é€»è¾‘ï¼Œæˆå°±ID: "${achievement.id}", æ ‡é¢˜: "${achievement.title}"`)
        
        switch (achievement.title) {
          case 'åˆå­¦è€…':
            console.info(`æ£€æŸ¥æˆå°± ${achievement.title}: totalQuestions=${userStats.totalQuestions}, å½“å‰è¿›åº¦=${achievement.progress}, å·²è§£é”=${achievement.isUnlocked}`)
            if (userStats.totalQuestions > 0) {
              newProgress = 1
              shouldUpdate = true
              console.info(`æˆå°± ${achievement.title} åº”è¯¥è§£é”`)
            }
            break

          case 'å°è¯•ç‰›åˆ€':
            console.info(`æ£€æŸ¥æˆå°± ${achievement.title}: correctAnswers=${userStats.correctAnswers}, å½“å‰è¿›åº¦=${achievement.progress}`)
            newProgress = Math.min(userStats.correctAnswers, 10)
            shouldUpdate = newProgress !== achievement.progress
            if (shouldUpdate) {
              console.info(`æˆå°± ${achievement.title} è¿›åº¦æ›´æ–°: ${achievement.progress} -> ${newProgress}`)
            }
            break

          case 'å‹¤å­¦è‹¦ç»ƒ':
            console.info(`æ£€æŸ¥æˆå°± ${achievement.title}: correctAnswers=${userStats.correctAnswers}, å½“å‰è¿›åº¦=${achievement.progress}`)
            newProgress = Math.min(userStats.correctAnswers, 50)
            shouldUpdate = newProgress !== achievement.progress
            if (shouldUpdate) {
              console.info(`æˆå°± ${achievement.title} è¿›åº¦æ›´æ–°: ${achievement.progress} -> ${newProgress}`)
            }
            break

          case 'å­¦éœ¸':
            console.info(`æ£€æŸ¥æˆå°± ${achievement.title}: correctAnswers=${userStats.correctAnswers}, å½“å‰è¿›åº¦=${achievement.progress}`)
            newProgress = Math.min(userStats.correctAnswers, 100)
            shouldUpdate = newProgress !== achievement.progress
            if (shouldUpdate) {
              console.info(`æˆå°± ${achievement.title} è¿›åº¦æ›´æ–°: ${achievement.progress} -> ${newProgress}`)
            }
            break

          case 'è€ƒæ ¸æ–°æ‰‹':
            console.info(`æ£€æŸ¥æˆå°± ${achievement.title}: examRecords=${examRecords.length}, å½“å‰è¿›åº¦=${achievement.progress}`)
            if (examRecords.length > 0) {
              newProgress = 1
              shouldUpdate = true
              console.info(`æˆå°± ${achievement.title} åº”è¯¥è§£é”`)
            }
            break

          case 'å®Œç¾ç­”å·':
            const perfectExams = examRecords.filter(exam => exam.score === 100)
            console.info(`æ£€æŸ¥æˆå°± ${achievement.title}: perfectExams=${perfectExams.length}, å½“å‰è¿›åº¦=${achievement.progress}`)
            if (perfectExams.length > 0) {
              newProgress = 1
              shouldUpdate = true
              console.info(`æˆå°± ${achievement.title} åº”è¯¥è§£é”`)
            }
            break

          case 'è€ƒæ ¸è¾¾äºº':
            const passedExams = examRecords.filter(exam => exam.passed)
            console.info(`æ£€æŸ¥æˆå°± ${achievement.title}: passedExams=${passedExams.length}, å½“å‰è¿›åº¦=${achievement.progress}`)
            newProgress = Math.min(passedExams.length, 5)
            shouldUpdate = newProgress !== achievement.progress
            if (shouldUpdate) {
              console.info(`æˆå°± ${achievement.title} è¿›åº¦æ›´æ–°: ${achievement.progress} -> ${newProgress}`)
            }
            break

          case 'ç²¾å‡†å°„æ‰‹':
            console.info(`æ£€æŸ¥æˆå°± ${achievement.title}: accuracy=${userStats.accuracy}%, totalQuestions=${userStats.totalQuestions}, å½“å‰è¿›åº¦=${achievement.progress}`)
            if (userStats.accuracy >= 90 && userStats.totalQuestions >= 20) {
              newProgress = 1
              shouldUpdate = true
              console.info(`æˆå°± ${achievement.title} åº”è¯¥è§£é”`)
            }
            break
            
          default:
            console.info(`æœªçŸ¥æˆå°±: ${achievement.title}`)
            break
        }

        if (shouldUpdate) {
          console.info(`æ›´æ–°æˆå°± ${achievement.id}: æ—§è¿›åº¦=${achievement.progress}, æ–°è¿›åº¦=${newProgress}`)
          achievement.updateProgress(newProgress)
          await this.databaseManager.updateAchievement(achievement)
          console.info(`æˆå°± ${achievement.id} æ›´æ–°å: è¿›åº¦=${achievement.progress}, å·²è§£é”=${achievement.isUnlocked}`)
          
          if (achievement.isUnlocked) {
            console.info(`ğŸ‰ æˆå°±è§£é”: ${achievement.title}`)
            // è¿™é‡Œå¯ä»¥æ·»åŠ æˆå°±è§£é”çš„é€šçŸ¥é€»è¾‘
          }
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥æˆå°±è¿›åº¦å¤±è´¥:', error)
    }
  }

  // è·å–é»˜è®¤æˆå°±åˆ—è¡¨
  private getDefaultAchievements(): AchievementModel[] {
    const achievements: AchievementModel[] = []

    // å­¦ä¹ æˆå°±
    achievements.push(new AchievementModel('first_question', 'åˆå­¦è€…', 'å®Œæˆç¬¬ä¸€é“é¢˜ç›®', 'ğŸ¯', 'å­¦ä¹ æˆå°±', 1, 'common'))
    achievements.push(new AchievementModel('answer_10', 'å°è¯•ç‰›åˆ€', 'ç´¯è®¡ç­”å¯¹10é“é¢˜ç›®', 'ğŸ“š', 'å­¦ä¹ æˆå°±', 10, 'common'))
    achievements.push(new AchievementModel('answer_50', 'å‹¤å­¦è‹¦ç»ƒ', 'ç´¯è®¡ç­”å¯¹50é“é¢˜ç›®', 'ğŸ†', 'å­¦ä¹ æˆå°±', 50, 'rare'))
    achievements.push(new AchievementModel('answer_100', 'å­¦éœ¸', 'ç´¯è®¡ç­”å¯¹100é“é¢˜ç›®', 'ğŸ‘‘', 'å­¦ä¹ æˆå°±', 100, 'epic'))

    // è€ƒæ ¸æˆå°±
    achievements.push(new AchievementModel('first_exam', 'è€ƒæ ¸æ–°æ‰‹', 'å®Œæˆç¬¬ä¸€æ¬¡è€ƒæ ¸', 'ğŸ“', 'è€ƒæ ¸æˆå°±', 1, 'common'))
    achievements.push(new AchievementModel('exam_perfect', 'å®Œç¾ç­”å·', 'åœ¨è€ƒæ ¸ä¸­è·å¾—æ»¡åˆ†', 'â­', 'è€ƒæ ¸æˆå°±', 1, 'epic'))
    achievements.push(new AchievementModel('exam_pass_5', 'è€ƒæ ¸è¾¾äºº', 'é€šè¿‡5æ¬¡è€ƒæ ¸', 'ğŸ–ï¸', 'è€ƒæ ¸æˆå°±', 5, 'rare'))

    // å‡†ç¡®ç‡æˆå°±
    achievements.push(new AchievementModel('high_accuracy', 'ç²¾å‡†å°„æ‰‹', 'ç­”é¢˜å‡†ç¡®ç‡è¾¾åˆ°90%ï¼ˆè‡³å°‘20é¢˜ï¼‰', 'ğŸ¯', 'å‡†ç¡®ç‡æˆå°±', 1, 'rare'))

    return achievements
  }

  // åœ¨ç­”é¢˜åè°ƒç”¨
  async onQuestionAnswered(isCorrect: boolean): Promise<void> {
    await this.checkAndUpdateAchievements()
  }

  // åœ¨è€ƒæ ¸å®Œæˆåè°ƒç”¨
  async onExamCompleted(score: number, passed: boolean): Promise<void> {
    await this.checkAndUpdateAchievements()
  }
}