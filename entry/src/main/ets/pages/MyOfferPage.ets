import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { OfferModel, OfferStatus, JobType, WorkMode } from '../model/OfferModel';
import { AppButton, AppButtonType } from '../component/AppButton';
import { AppLoading } from '../component/AppLoading';
import { DatabaseManager, OfferStatistics } from '../common/DatabaseManager';

interface GroupedOffers {
  pending: OfferModel[];
  accepted: OfferModel[];
  rejected: OfferModel[];
  expired: OfferModel[];
}

@Entry
@Component
struct MyOfferPage {
  @State private offers: OfferModel[] = [];
  @State private filteredOffers: OfferModel[] = [];
  @State private groupedOffers: GroupedOffers = {
    pending: [],
    accepted: [],
    rejected: [],
    expired: []
  };
  @State private isLoading: boolean = true;
  @State private searchText: string = '';
  @State private selectedStatus: string = 'all';
  @State private selectedJobType: string = 'all';
  @State private showGroupedView: boolean = true;
  @State private statistics: OfferStatistics = {
    total: 0,
    pending: 0,
    accepted: 0,
    rejected: 0,
    expired: 0,
    avgSalary: 0,
    maxSalary: 0
  };

  private databaseManager: DatabaseManager = DatabaseManager.getInstance()

  @State private currentTab: number = 0;

  private tabTitles: string[] = ['å…¨éƒ¨', 'ç´§æ€¥', 'å·²æ”¶åˆ°', 'å¾…å®š', 'å·²æ¥å—', 'å·²æ‹’ç»', 'å·²è¿‡æœŸ'];


  onPageShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°åŠ è½½æ•°æ®ï¼Œç¡®ä¿ä»å…¶ä»–é¡µé¢è¿”å›æ—¶æ•°æ®æ˜¯æœ€æ–°çš„
    this.loadData();
  }

  private async loadData(): Promise<void> {
    try {
      this.isLoading = true;
      await this.loadOffers();
      await this.calculateStatistics();
      this.filterOffers();
    } catch (error) {
      console.error('Failed to load offers:', error);
    } finally {
      this.isLoading = false;
    }
  }

  private async loadOffers(): Promise<void> {
    this.offers = await this.databaseManager.getAllOffers();
    
    // æŒ‰çŠ¶æ€åˆ†ç»„
    const pendingOffers = await this.databaseManager.getOffersByStatus(OfferStatus.PENDING);
    const acceptedOffers = await this.databaseManager.getOffersByStatus(OfferStatus.ACCEPTED);
    const rejectedOffers = await this.databaseManager.getOffersByStatus(OfferStatus.REJECTED);
    const expiredOffers = await this.databaseManager.getOffersByStatus(OfferStatus.EXPIRED);
    
    this.groupedOffers = {
      pending: pendingOffers,
      accepted: acceptedOffers,
      rejected: rejectedOffers,
      expired: expiredOffers
    };
  }

  private async calculateStatistics(): Promise<void> {
    this.statistics = await this.databaseManager.getOfferStats();
  }

  private filterOffers() {
    let filtered = this.offers;

    // æŒ‰çŠ¶æ€ç­›é€‰
    if (this.selectedStatus !== 'all') {
      if (this.selectedStatus === 'urgent') {
        // ç´§æ€¥çŠ¶æ€ï¼šå¾…å®šä¸”å›å¤æˆªæ­¢æ—¥æœŸåœ¨7å¤©å†…
        filtered = this.getUrgentOffers();
      } else {
        filtered = filtered.filter(offer => offer.status === this.selectedStatus);
      }
    }

    // æŒ‰å·¥ä½œç±»å‹ç­›é€‰
    if (this.selectedJobType !== 'all') {
      filtered = filtered.filter(offer => offer.jobType === this.selectedJobType);
    }

    // æŒ‰æœç´¢æ–‡æœ¬ç­›é€‰
    if (this.searchText.trim()) {
      const searchLower = this.searchText.toLowerCase();
      filtered = filtered.filter(offer => 
        offer.company.toLowerCase().includes(searchLower) ||
        offer.position.toLowerCase().includes(searchLower) ||
        offer.department.toLowerCase().includes(searchLower)
      );
    }

    // æŒ‰ä¼˜å…ˆçº§å’Œè–ªèµ„æ’åº
    filtered.sort((a, b) => {
      const priorityDiff = b.getPriority() - a.getPriority();
      if (priorityDiff !== 0) return priorityDiff;
      return b.getTotalCompensation() - a.getTotalCompensation();
    });

    this.filteredOffers = filtered;
  }

  private onSearchTextChange(value: string) {
    this.searchText = value;
    this.filterOffers();
  }

  private onStatusFilterChange(status: string) {
    this.selectedStatus = status;
    this.filterOffers();
  }

  private onJobTypeFilterChange(jobType: string) {
    this.selectedJobType = jobType;
    this.filterOffers();
  }

  private onTabChange(index: number) {
    this.currentTab = index;
    switch (index) {
      case 0: // å…¨éƒ¨
        this.selectedStatus = 'all';
        break;
      case 1: // ç´§æ€¥
        this.selectedStatus = 'urgent';
        break;
      case 2: // å·²æ”¶åˆ°
        this.selectedStatus = OfferStatus.RECEIVED;
        break;
      case 3: // å¾…å®š
        this.selectedStatus = OfferStatus.PENDING;
        break;
      case 4: // å·²æ¥å—
        this.selectedStatus = OfferStatus.ACCEPTED;
        break;
      case 5: // å·²æ‹’ç»
        this.selectedStatus = OfferStatus.REJECTED;
        break;
      case 6: // å·²è¿‡æœŸ
        this.selectedStatus = OfferStatus.EXPIRED;
        break;
    }
    this.filterOffers();
  }

  private navigateToEdit(offer: OfferModel) {
    router.pushUrl({
      url: 'pages/AddOfferPage',
      params: { offer: offer }
    }).catch((error: Error) => {
      console.error('Failed to navigate to edit:', error);
    });
  }

  private navigateToAdd() {
    router.pushUrl({
      url: 'pages/AddOfferPage'
    }).catch((error: Error) => {
      console.error('Failed to navigate to add:', error);
    });
  }

  private navigateToComparison() {
    router.pushUrl({
      url: 'pages/OfferComparisonPage'
    }).catch((error: Error) => {
      console.error('Failed to navigate to comparison:', error);
    });
  }

  private async deleteOffer(offer: OfferModel) {
    try {
      // ä»æŒä¹…åŒ–æ•°æ®ä¸­åˆ é™¤
      await this.databaseManager.deleteOffer(offer.id);
      await this.loadOffers();
      
      // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
      await this.calculateStatistics();
      
      // é‡æ–°ç­›é€‰æ•°æ®
      this.filterOffers();
      
      // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
      promptAction.showToast({
        message: 'åˆ é™¤æˆåŠŸ',
        duration: 2000
      });
    } catch (error) {
      console.error('Delete offer failed:', error);
      promptAction.showToast({
        message: 'åˆ é™¤å¤±è´¥',
        duration: 2000
      });
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      this.buildHeader()
      
      if (this.isLoading) {
        this.buildLoadingState()
      } else {
        Column() {
          // ç»Ÿè®¡å¡ç‰‡
          this.buildStatisticsCard()
          
          // Tabæ 
          this.buildTabBar()
          
          // ç­›é€‰æ 
          this.buildFilterBar()
          
          // Offeråˆ—è¡¨
          this.buildOfferList()
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Row() {
      Button() {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back();
      })

      Text('æˆ‘çš„offer')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button() {
        Image($r('app.media.icon_add'))
          .width(36)
          .height(36)
          .fillColor('#FF6B35')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.navigateToAdd();
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
  }

  @Builder
  buildLoadingState() {
    Column({ space: 16 }) {
      AppLoading({ loadingText: 'æ­£åœ¨åŠ è½½Offerä¿¡æ¯...' })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildStatisticsCard() {
    Column({ space: 16 }) {
      Text('Offeræ¦‚è§ˆ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .alignSelf(ItemAlign.Start)

      // ç¬¬ä¸€è¡Œç»Ÿè®¡
      Row({ space: 20 }) {
        this.buildStatItem('æ€»è®¡', this.statistics.total.toString(), '#1890ff')
        this.buildStatItem('å¾…å¤„ç†', this.statistics.pending.toString(), '#52c41a')
        this.buildStatItem('å·²æ¥å—', this.statistics.accepted.toString(), '#722ed1')
        this.buildStatItem('å·²è¿‡æœŸ', this.statistics.expired.toString(), '#ff4d4f')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)

      // ç¬¬äºŒè¡Œç»Ÿè®¡
      Row({ space: 20 }) {
        this.buildSalaryStatItem('æœ€é«˜è–ªèµ„', this.formatSalary(this.statistics.maxSalary), '#fa8c16')
        this.buildSalaryStatItem('å¹³å‡è–ªèµ„', this.formatSalary(this.statistics.avgSalary), '#13c2c2')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16, top: 12 })
    .backgroundColor('#ffffff')
    .borderRadius(8)
  }

  @Builder
  buildStatItem(title: string, value: string, color: string) {
    Column({ space: 4 }) {
      Text(value)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
    }
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildSalaryStatItem(title: string, value: string, color: string) {
    Column({ space: 4 }) {
      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
    }
    .alignItems(HorizontalAlign.Center)
    .layoutWeight(1)
  }

  @Builder
  buildTabBar() {
    Row() {
      ForEach(this.tabTitles, (title: string, index: number) => {
        Column({ space: 4 }) {
          Text(title)
            .fontSize(14)
            .fontColor(this.currentTab === index ? '#1890ff' : '#666666')
            .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Normal)

          if (this.currentTab === index) {
            Column()
              .width(20)
              .height(2)
              .backgroundColor('#1890ff')
              .borderRadius(1)
          }
        }
        .layoutWeight(1)
        .padding({ top: 12, bottom: 12 })
        .onClick(() => {
          this.onTabChange(index);
        })
      }, (title: string, index: number) => index.toString())
    }
    .width('100%')
    .backgroundColor('#ffffff')
    .margin({ left: 16, right: 16, top: 8 })
    .borderRadius(8)
  }

  @Builder
  buildFilterBar() {
    Column({ space: 12 }) {
      // æœç´¢æ¡†
      Row({ space: 12 }) {
        Image($r('app.media.icon_search'))
          .width(20)
          .height(20)

        TextInput({ placeholder: 'æœç´¢å…¬å¸ã€èŒä½æˆ–éƒ¨é—¨' })
          .layoutWeight(1)
          .height(40)
          .backgroundColor('transparent')
          .border({ width: 0 })
          .onChange((value: string) => {
            this.onSearchTextChange(value);
          })
      }
      .width('100%')
      .height(48)
      .padding({ left: 12, right: 12 })
      .backgroundColor('#f8f9fa')
      .borderRadius(8)
      .visibility(Visibility.None)

      // ç­›é€‰èŠ¯ç‰‡
      Row({ space: 8 }) {
        Text('ç±»å‹:')
          .fontSize(14)
          .fontColor('#666666')

        this.buildJobTypeFilterChip('å…¨éƒ¨', 'all')
        this.buildJobTypeFilterChip('å…¨èŒ', JobType.FULL_TIME)
        this.buildJobTypeFilterChip('å®ä¹ ', JobType.INTERN)
        this.buildJobTypeFilterChip('å…¼èŒ', JobType.PART_TIME)
      }
      .width('100%').visibility(Visibility.None)
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16, top: 8 })
    .backgroundColor('#ffffff')
    .borderRadius(8)
  }

  @Builder
  buildJobTypeFilterChip(text: string, value: string) {
    Text(text)
      .fontSize(12)
      .fontColor(this.selectedJobType === value ? '#ffffff' : '#666666')
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .backgroundColor(this.selectedJobType === value ? '#1890ff' : '#f0f0f0')
      .borderRadius(16)
      .onClick(() => {
        this.onJobTypeFilterChange(value);
      })
  }

  @Builder
  buildOfferList() {
    if (this.currentTab === 1) {
      // ç´§æ€¥å¤„ç†Tab
      List({ space: 8 }) {
        ForEach(this.getUrgentOffers(), (offer: OfferModel) => {
          ListItem() {
            this.buildUrgentOfferCard(offer)
          }
          .swipeAction({ end: this.buildSwipeAction(offer) })
        }, (offer: OfferModel) => offer.id.toString())
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16, top: 8 })
    } else {
      // å…¶ä»–Tab
      if (this.filteredOffers.length === 0) {
        this.buildEmptyState('æš‚æ— Offerè®°å½•')
      } else {
        List({ space: 8 }) {
          ForEach(this.filteredOffers, (offer: OfferModel) => {
            ListItem() {
              this.buildOfferCard(offer)
            }
            .swipeAction({ end: this.buildSwipeAction(offer) })
          }, (offer: OfferModel) => offer.id.toString())
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, top: 8 })
      }
    }
  }



  @Builder
  buildUrgentOfferCard(offer: OfferModel) {
    Column({ space: 12 }) {
      // ç´§æ€¥æ ‡è¯†
      Row() {
        Text('ğŸš¨ ç´§æ€¥å¤„ç†')
          .fontSize(12)
          .fontColor('#ffffff')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('#ff4d4f')
          .borderRadius(12)

        Blank()

        Text(offer.getRemainingDaysText())
          .fontSize(12)
          .fontColor('#ff4d4f')
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')

      this.buildOfferCardContent(offer)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(8)
    .border({ width: 2, color: '#ff4d4f' })
    .onClick(() => {
      this.navigateToEdit(offer);
    })
  }

  @Builder
  buildOfferCard(offer: OfferModel) {
    Column({ space: 12 }) {
      this.buildOfferCardContent(offer)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(8)
    .onClick(() => {
      this.navigateToEdit(offer);
    })
  }

  @Builder
  buildOfferCardContent(offer: OfferModel) {
    Column({ space: 12 }) {
      // å¤´éƒ¨ä¿¡æ¯
      Row({ space: 12 }) {
        Column({ space: 4 }) {
          Text(offer.company)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          Text(offer.position)
            .fontSize(14)
            .fontColor('#666666')

          if (offer.department) {
            Text(offer.department)
              .fontSize(12)
              .fontColor('#999999')
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Column({ space: 4 }) {
          Text(offer.getStatusText())
            .fontSize(12)
            .fontColor('#ffffff')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(offer.getStatusColor())
            .borderRadius(12)

          Text(offer.getSalaryLevel())
            .fontSize(12)
            .fontColor('#ffffff')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(offer.getSalaryLevelColor())
            .borderRadius(12)
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')

      // è–ªèµ„ä¿¡æ¯
      Row({ space: 16 }) {
        Column({ space: 4 }) {
          Text('æ€»åŒ…è–ªèµ„')
            .fontSize(12)
            .fontColor('#666666')

          Text(offer.getFormattedTotalCompensation())
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1890ff')
        }
        .alignItems(HorizontalAlign.Start)

        if (offer.stockOptions) {
          Column({ space: 4 }) {
            Text('è‚¡ç¥¨æœŸæƒ')
              .fontSize(12)
              .fontColor('#666666')

            Text('æœ‰')
              .fontSize(14)
              .fontColor('#52c41a')
          }
          .alignItems(HorizontalAlign.Start)
        }

        Blank()

        Column({ space: 4 }) {
          Text(offer.getJobTypeText())
            .fontSize(12)
            .fontColor('#666666')

          Text(offer.getWorkModeText())
            .fontSize(12)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')

      // åœ°ç‚¹å’Œæ—¶é—´
      Row({ space: 16 }) {
        if (offer.location) {
          Row({ space: 4 }) {
            Image($r('app.media.map_icon'))
              .width(16)
              .height(16)

            Text(offer.location)
              .fontSize(12)
              .fontColor('#666666')
          }
        }

        if (offer.offerDate) {
          Row({ space: 4 }) {
            Image($r('app.media.calendar_icon'))
              .width(16)
              .height(16)

            Text(offer.getFormattedDate(offer.offerDate))
              .fontSize(12)
              .fontColor('#666666')
          }
        }

        Blank()

        if (offer.satisfactionScore > 0) {
          Text(offer.getSatisfactionStars())
            .fontSize(12)
            .fontColor('#faad14')
        }
      }
      .width('100%')

      // å¤‡æ³¨
      if (offer.notes) {
        Text(offer.notes)
          .fontSize(12)
          .fontColor('#999999')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
    }
  }

  @Builder
  buildEmptyState(message: string) {
    Column({ space: 16 }) {
      Image($r('app.media.icon_empty'))
        .width(58)
        .height(42)
        .opacity(0.5)

      Text(message)
        .fontSize(16)
        .fontColor('#999999')

      AppButton({
        buttonText: 'æ·»åŠ Offer',
        type: AppButtonType.PRIMARY,
        onButtonClick: () => {
          this.navigateToAdd();
        }
      })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  private formatSalary(amount: number): string {
    if (amount === 0) return '0';
    return `${amount.toFixed(1)}ä¸‡`;
  }

  @Builder
  buildSwipeAction(offer: OfferModel) {
    Row() {
      Button() {
        Column() {
          Image($r('app.media.icon_delete'))
            .width(24)
            .height(24)
            .fillColor('#FF6B35')
          Text('åˆ é™¤')
            .fontSize(12)
            .fontColor('#FF6B35')
            .margin({ top: 4 })
        }
      }
      .width(80)
      .backgroundColor(Color.Transparent)
      .height('100%')
      .borderRadius(0)
      .onClick(() => {
        AlertDialog.show({
          title: 'ç¡®è®¤åˆ é™¤',
          message: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®°å½•å—ï¼Ÿ\nåˆ é™¤åæ— æ³•æ¢å¤ã€‚',
          primaryButton: {
            value: 'å–æ¶ˆ',
            action: () => {
              console.info('å–æ¶ˆåˆ é™¤');
            }
          },
          secondaryButton: {
            value: 'åˆ é™¤',
            fontColor: '#FF4444',
            action: () => {
              this.deleteOffer(offer);
            }
          }
        });
      })
    }
    .height('100%')
  }

  private getUrgentOffers(): OfferModel[] {
    return this.offers.filter(offer => {
      if (offer.status === OfferStatus.PENDING && offer.responseDate) {
        const deadline = new Date(offer.responseDate);
        const now = new Date();
        const diffDays = Math.ceil((deadline.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
        return diffDays <= 7 && diffDays >= 0;
      }
      return false;
    });
  }
}