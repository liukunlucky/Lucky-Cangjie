import router from '@ohos.router'
import { promptAction } from '@kit.ArkUI'
import { DatabaseManager } from '../common/DatabaseManager'
import { DiaryEntryModel } from '../common/models/DiaryEntryModel'

interface SampleDiaryData {
  date: string
  title: string
  content: string
  mood: string
  studyTime: number
  questionsAnswered: number
}

@Entry
@Component
struct DiaryPage {
  @State diaryEntries: DiaryEntryModel[] = []
  @State selectedDate: string = ''
  @State showAddEntry: boolean = false
  @State showEntryDetail: boolean = false
  @State selectedEntry: DiaryEntryModel | null = null
  @State newEntryTitle: string = ''
  @State newEntryContent: string = ''
  @State newEntryMood: string = 'üòä'
  @State newEntryStudyTime: string = ''
  @State newEntryQuestions: string = ''
  @State currentMonth: string = ''
  private databaseManager: DatabaseManager = DatabaseManager.getInstance()

  aboutToAppear() {
    this.initCurrentMonth()
    this.loadDiaryEntries()
  }

  initCurrentMonth() {
    const now = new Date()
    this.currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`
    this.selectedDate = now.toISOString().split('T')[0]
  }

  async loadDiaryEntries() {
    try {
      this.diaryEntries = await this.databaseManager.getAllDiaryEntries()
      
      // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºåÊòæÁ§∫mockÊï∞ÊçÆÔºà‰∏çÊ∑ªÂä†Âà∞Êï∞ÊçÆÂ∫ìÔºâ
      if (this.diaryEntries.length === 0) {
        this.loadMockDiaryEntries()
      }
    } catch (error) {
      console.error('Failed to load diary entries:', error)
      // Â¶ÇÊûúÊï∞ÊçÆÂ∫ìÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®mockÊï∞ÊçÆ
      this.loadMockDiaryEntries()
    }
  }

  private async addSampleDiaryEntries() {
    const sampleEntries: SampleDiaryData[] = [
      {
        date: '2024-01-15',
        title: 'ÂºÄÂßãÂ≠¶‰π†‰ªìÈ¢âËØ≠Ë®Ä',
        content: '‰ªäÂ§©ÂºÄÂßãÂ≠¶‰π†‰ªìÈ¢âËØ≠Ë®ÄÔºåÊÑüËßâËØ≠Ê≥ïÂíåÂÖ∂‰ªñËØ≠Ë®ÄÊúâ‰∫õÁõ∏‰ººÔºå‰ΩÜ‰πüÊúâÁã¨ÁâπÁöÑÂú∞Êñπ„ÄÇÂÆåÊàê‰∫ÜÂü∫Á°ÄËØ≠Ê≥ïÁöÑÂ≠¶‰π†ÔºåÁ≠îÂØπ‰∫Ü8ÈÅìÈ¢òÁõÆ„ÄÇ',
        mood: 'üéâ',
        studyTime: 2.5,
        questionsAnswered: 8
      },
      {
        date: '2024-01-16',
        title: 'ÂáΩÊï∞ÂíåÁ±ªÁöÑÂ≠¶‰π†',
        content: '‰ªäÂ§©Â≠¶‰π†‰∫ÜÂáΩÊï∞ÂÆö‰πâÂíåÁ±ªÁöÑÊ¶ÇÂøµÔºåÂÅö‰∫Ü‰∏Ä‰∫õÁªÉ‰π†È¢ò„ÄÇÊúâÂá†ÈÅìÈ¢òÁõÆÊØîËæÉÈöæÔºå‰ΩÜÊúÄÁªàÈÉΩËß£ÂÜ≥‰∫Ü„ÄÇÊÑüËßâËøõÊ≠•ÂæàÊòéÊòæ„ÄÇ',
        mood: 'üòä',
        studyTime: 3,
        questionsAnswered: 12
      },
      {
        date: '2024-01-17',
        title: 'Â§ç‰π†ÂíåÂ∑©Âõ∫',
        content: '‰ªäÂ§©‰∏ªË¶ÅÊòØÂ§ç‰π†Ââç‰∏§Â§©Â≠¶ÁöÑÂÜÖÂÆπÔºåÂÅö‰∫Ü‰∏Ä‰∫õÁªºÂêàÁªÉ‰π†„ÄÇÂèëÁé∞ËøòÊúâ‰∏Ä‰∫õÁü•ËØÜÁÇπ‰∏çÂ§üÁÜüÁªÉÔºåÈúÄË¶ÅÁªßÁª≠Âä†Âº∫„ÄÇ',
        mood: 'üòê',
        studyTime: 1.5,
        questionsAnswered: 6
      }
    ]

    for (const entryData of sampleEntries) {
      const entry = new DiaryEntryModel()
      entry.date = entryData.date
      entry.title = entryData.title
      entry.content = entryData.content
      entry.mood = entryData.mood
      entry.studyTime = entryData.studyTime
      entry.questionsAnswered = entryData.questionsAnswered
      
      await this.databaseManager.addDiaryEntry(entry)
    }
  }

  private loadMockDiaryEntries() {
    // ÊòæÁ§∫mockÊï∞ÊçÆÔºå‰∏ç‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    const mockEntries: DiaryEntryModel[] = []
    
    const entry1 = new DiaryEntryModel()
    entry1.id = -1 // ‰ΩøÁî®Ë¥üÊï∞IDÊ†áËØÜmockÊï∞ÊçÆ
    entry1.date = '2024-01-15'
    entry1.title = 'ÂºÄÂßãÂ≠¶‰π†‰ªìÈ¢âËØ≠Ë®Ä'
    entry1.content = '‰ªäÂ§©ÂºÄÂßãÂ≠¶‰π†‰ªìÈ¢âËØ≠Ë®ÄÔºåÊÑüËßâËØ≠Ê≥ïÂíåÂÖ∂‰ªñËØ≠Ë®ÄÊúâ‰∫õÁõ∏‰ººÔºå‰ΩÜ‰πüÊúâÁã¨ÁâπÁöÑÂú∞Êñπ„ÄÇÂÆåÊàê‰∫ÜÂü∫Á°ÄËØ≠Ê≥ïÁöÑÂ≠¶‰π†ÔºåÁ≠îÂØπ‰∫Ü8ÈÅìÈ¢òÁõÆ„ÄÇÂ≠¶‰π†ËøáÁ®ã‰∏≠ÈÅáÂà∞‰∫Ü‰∏Ä‰∫õÊåëÊàòÔºå‰ΩÜÈÄöËøáÊü•ÈòÖËµÑÊñôÂíåÁªÉ‰π†ÈÄêÊ≠•ÂÖãÊúç‰∫Ü„ÄÇ'
    entry1.mood = 'üéâ'
    entry1.studyTime = 2.5
    entry1.questionsAnswered = 8
    mockEntries.push(entry1)

    const entry2 = new DiaryEntryModel()
    entry2.id = -2
    entry2.date = '2024-01-16'
    entry2.title = 'ÂáΩÊï∞ÂíåÁ±ªÁöÑÂ≠¶‰π†'
    entry2.content = '‰ªäÂ§©Â≠¶‰π†‰∫ÜÂáΩÊï∞ÂÆö‰πâÂíåÁ±ªÁöÑÊ¶ÇÂøµÔºåÂÅö‰∫Ü‰∏Ä‰∫õÁªÉ‰π†È¢ò„ÄÇÊúâÂá†ÈÅìÈ¢òÁõÆÊØîËæÉÈöæÔºå‰ΩÜÊúÄÁªàÈÉΩËß£ÂÜ≥‰∫Ü„ÄÇÊÑüËßâËøõÊ≠•ÂæàÊòéÊòæÔºåÂØπÈù¢ÂêëÂØπË±°ÁºñÁ®ãÊúâ‰∫ÜÊõ¥Ê∑±ÁöÑÁêÜËß£„ÄÇ'
    entry2.mood = 'üòä'
    entry2.studyTime = 3
    entry2.questionsAnswered = 12
    mockEntries.push(entry2)

    const entry3 = new DiaryEntryModel()
    entry3.id = -3
    entry3.date = '2024-01-17'
    entry3.title = 'Êï∞ÊçÆÁªìÊûÑ‰∏éÁÆóÊ≥ïÁªÉ‰π†'
    entry3.content = '‰ªäÂ§©‰∏ìÊ≥®‰∫éÊï∞ÊçÆÁªìÊûÑÂíåÁÆóÊ≥ïÁöÑÂ≠¶‰π†ÔºåÂÆåÊàê‰∫ÜÊï∞ÁªÑ„ÄÅÈìæË°®Áõ∏ÂÖ≥ÁöÑÈ¢òÁõÆ„ÄÇËôΩÁÑ∂Êúâ‰∫õÈ¢òÁõÆÊØîËæÉÂ§çÊùÇÔºå‰ΩÜÈÄöËøáÂèçÂ§çÁªÉ‰π†ÂíåÊÄùËÄÉÔºåÈÄêÊ∏êÊéåÊè°‰∫ÜËß£È¢òÊÄùË∑Ø„ÄÇ'
    entry3.mood = 'ü§î'
    entry3.studyTime = 4
    entry3.questionsAnswered = 15
    mockEntries.push(entry3)

    const entry4 = new DiaryEntryModel()
    entry4.id = -4
    entry4.date = '2024-01-18'
    entry4.title = 'È°πÁõÆÂÆûÊàòÁªÉ‰π†'
    entry4.content = '‰ªäÂ§©ÂºÄÂßã‰∫Ü‰∏Ä‰∏™Â∞èÈ°πÁõÆÁöÑÂºÄÂèëÔºåÂ∞Ü‰πãÂâçÂ≠¶Âà∞ÁöÑÁü•ËØÜÂ∫îÁî®Âà∞ÂÆûÈôÖÈ°πÁõÆ‰∏≠„ÄÇÈÅáÂà∞‰∫Ü‰∏Ä‰∫õÂÆûÈôÖÂºÄÂèë‰∏≠ÁöÑÈóÆÈ¢òÔºå‰ΩÜÈÄöËøáÊü•ÈòÖÊñáÊ°£ÂíåË∞ÉËØïËß£ÂÜ≥‰∫ÜÂ§ßÈÉ®ÂàÜÈóÆÈ¢ò„ÄÇ'
    entry4.mood = 'üò§'
    entry4.studyTime = 5
    entry4.questionsAnswered = 10
    mockEntries.push(entry4)

    this.diaryEntries = mockEntries
  }

  getMoodEmoji(mood: string): string {
    return mood
  }

  getMoodName(mood: string): string {
    switch (mood) {
      case 'üòä': return 'ÂºÄÂøÉ'
      case 'üéâ': return 'ÂÖ¥Â•ã'
      case 'üòê': return 'Âπ≥Èùô'
      case 'üòî': return 'Ê≤Æ‰∏ß'
      case 'üò¥': return 'Áñ≤ÊÉ´'
      case 'ü§î': return 'ÊÄùËÄÉ'
      case 'üò§': return 'Âä™Âäõ'
      default: return 'Âπ≥Èùô'
    }
  }

  async addNewEntry() {
    if (!this.newEntryTitle.trim()) {
      promptAction.showToast({
        message: 'ËØ∑ËæìÂÖ•Êó•ËÆ∞Ê†áÈ¢ò',
        duration: 2000
      })
      return
    }

    if (!this.newEntryContent.trim()) {
      promptAction.showToast({
        message: 'ËØ∑ËæìÂÖ•Êó•ËÆ∞ÂÜÖÂÆπ',
        duration: 2000
      })
      return
    }

    try {
      const entry = new DiaryEntryModel()
      entry.date = this.selectedDate
      entry.title = this.newEntryTitle
      entry.content = this.newEntryContent
      entry.mood = this.newEntryMood
      entry.studyTime = Number(this.newEntryStudyTime) || 0
      entry.questionsAnswered = Number(this.newEntryQuestions) || 0
      
      await this.databaseManager.addDiaryEntry(entry)

      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      await this.loadDiaryEntries()
      
      this.resetAddEntryForm()
      this.showAddEntry = false

      promptAction.showToast({
        message: 'Êó•ËÆ∞Ê∑ªÂä†ÊàêÂäüÔºÅ',
        duration: 2000
      })
    } catch (error) {
      console.error('Failed to add diary entry:', error)
      promptAction.showToast({
        message: 'Ê∑ªÂä†Êó•ËÆ∞Â§±Ë¥•ÔºåËØ∑ÈáçËØï',
        duration: 2000
      })
    }
  }

  resetAddEntryForm() {
    this.newEntryTitle = ''
    this.newEntryContent = ''
    this.newEntryMood = 'üòä'
    this.newEntryStudyTime = ''
    this.newEntryQuestions = ''
  }

  async deleteEntry(entryId: number) {
    try {
      await this.databaseManager.deleteDiaryEntry(entryId)
      
      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      await this.loadDiaryEntries()
      
      promptAction.showToast({
        message: 'Êó•ËÆ∞Âà†Èô§ÊàêÂäü',
        duration: 2000
      })
    } catch (error) {
      console.error('Failed to delete diary entry:', error)
      promptAction.showToast({
        message: 'Âà†Èô§Êó•ËÆ∞Â§±Ë¥•ÔºåËØ∑ÈáçËØï',
        duration: 2000
      })
    }
  }

  formatDate(dateStr: string): string {
    const date = new Date(dateStr)
    const month = date.getMonth() + 1
    const day = date.getDate()
    const weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠']
    const weekday = weekdays[date.getDay()]
    return `${month}Êúà${day}Êó• ÊòüÊúü${weekday}`
  }

  build() {
    Stack() {
      Column() {
        this.HeaderSection()
        this.CalendarSection()
        this.DiaryList()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
      .justifyContent(FlexAlign.Start)

      if (this.showAddEntry) {
        this.AddEntryDialog()
      }

      if (this.showEntryDetail && this.selectedEntry) {
        this.EntryDetailDialog()
      }
    }
  }

  @Builder HeaderSection() {
    Row() {
      Image($r('app.media.ic_back'))
        .width(24)
        .height(24)
        .fillColor('#333333')
        .onClick(() => {
          router.back()
        })
      
      Text('ÊàëÁöÑÊó•ËÆ∞')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      Image($r('app.media.ic_add'))
        .width(24)
        .height(24)
        .fillColor('#007AFF')
        .onClick(() => {
          this.showAddEntry = true
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .shadow({ radius: 2, color: '#1A000000', offsetX: 0, offsetY: 1 })
  }

  @Builder CalendarSection() {
    Column() {
      Row() {
        Text(this.currentMonth)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        
        Blank()
        
        Text(`ÂÖ±${this.diaryEntries.length}ÁØáÊó•ËÆ∞`)
          .fontSize(14)
          .fontColor('#666666')
      }
      .width('100%')
      .margin({ bottom: 16 })

      // ÁÆÄÂåñÁöÑÊó•ÊúüÈÄâÊã©
      Row() {
        Text('ÈÄâÊã©Êó•ÊúüÔºö')
          .fontSize(14)
          .fontColor('#666666')
        
        Button(this.formatDate(this.selectedDate))
          .fontSize(14)
          .fontColor('#007AFF')
          .backgroundColor('#F0F8FF')
          .border({ width: 1, color: '#007AFF' })
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .onClick(() => {
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Êó•ÊúüÈÄâÊã©Âô®
            promptAction.showToast({
              message: 'Êó•ÊúüÈÄâÊã©ÂäüËÉΩÂºÄÂèë‰∏≠...',
              duration: 2000
            })
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .margin({ top: 8, bottom: 8 })
  }

  @Builder DiaryList() {
    Scroll() {
      Column({ space: 12 }) {
        if (this.diaryEntries.length === 0) {
          Column() {
            Text('üìù')
              .fontSize(48)
              .margin({ bottom: 16 })
            
            Text('ËøòÊ≤°ÊúâÊó•ËÆ∞ËÆ∞ÂΩï')
              .fontSize(16)
              .fontColor('#666666')
              .margin({ bottom: 8 })
            
            Text('ÁÇπÂáªÂè≥‰∏äËßí"+"ÂºÄÂßãËÆ∞ÂΩï‰Ω†ÁöÑÂ≠¶‰π†Êó•ËÆ∞Âêß')
              .fontSize(14)
              .fontColor('#999999')
          }
          .width('100%')
          .padding({ top: 40 })
          .alignItems(HorizontalAlign.Center)
        } else {
          ForEach(this.diaryEntries, (entry: DiaryEntryModel) => {
            this.DiaryCard(entry)
          }, (entry: DiaryEntryModel) => entry.id.toString())
        }
      }
      .padding(16)
    }
    .layoutWeight(1)
  }

  @Builder DiaryCard(entry: DiaryEntryModel) {
    Column() {
      Row() {
        Column() {
          Text(entry.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .width('100%')
            .textAlign(TextAlign.Start)
          
          Text(this.formatDate(entry.date))
            .fontSize(12)
            .fontColor('#666666')
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        Row() {
          Text(entry.mood)
            .fontSize(20)
          
          // Á§∫‰æãÊ†áÁ≠æÔºà‰ªÖÂØπmockÊï∞ÊçÆÊòæÁ§∫Ôºâ
          if (entry.id < 0) {
            Text('Á§∫‰æã')
              .fontSize(12)
              .fontColor('#FFFFFF')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .backgroundColor('#FF9800')
              .borderRadius(8)
              .margin({ left: 12 })
          }
          
          // Âè™ÊúâÁúüÂÆûÊï∞ÊçÆÊâçÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
          if (entry.id > 0) {
            Image($r('app.media.ic_delete'))
              .width(20)
              .height(20)
              .fillColor('#FF4444')
              .margin({ left: 12 })
              .onClick(() => {
                AlertDialog.show({
                  title: 'Á°ÆËÆ§Âà†Èô§',
                  message: `Á°ÆÂÆöË¶ÅÂà†Èô§Êó•ËÆ∞"${entry.title}"ÂêóÔºü`,
                  primaryButton: {
                    value: 'Âà†Èô§',
                    action: () => {
                      this.deleteEntry(entry.id)
                    }
                  },
                  secondaryButton: {
                    value: 'ÂèñÊ∂à',
                    action: () => {}
                  }
                })
              })
          }
        }
      }
      .width('100%')
      .margin({ bottom: 12 })

      Text(entry.content)
        .fontSize(14)
        .fontColor('#666666')
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('100%')
        .textAlign(TextAlign.Start)
        .margin({ bottom: 12 })

      Row() {
        if (entry.studyTime > 0) {
          Text(`Â≠¶‰π†${entry.studyTime}Â∞èÊó∂`)
            .fontSize(12)
            .fontColor('#007AFF')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor('#F0F8FF')
            .borderRadius(8)
        }

        if (entry.questionsAnswered > 0) {
          Text(`Á≠îÈ¢ò${entry.questionsAnswered}ÈÅì`)
            .fontSize(12)
            .fontColor('#4CAF50')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor('#F0FFF0')
            .borderRadius(8)
            .margin({ left: 8 })
        }

        Blank()

        Text('Êü•ÁúãËØ¶ÊÉÖ')
          .fontSize(12)
          .fontColor('#007AFF')
          .onClick(() => {
            this.selectedEntry = entry
            this.showEntryDetail = true
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#1A000000', offsetX: 0, offsetY: 2 })
  }

  @Builder AddEntryDialog() {
    Column() {
      // ÈÅÆÁΩ©Â±Ç
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#80000000')
        .onClick(() => {
          this.showAddEntry = false
          this.resetAddEntryForm()
        })
    }
    .width('100%')
    .height('100%')

    // ÂØπËØùÊ°ÜÂÜÖÂÆπ
    Scroll() {
      Column() {
        Text('ÂÜôÊó•ËÆ∞')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ bottom: 20 })

        // Ê†áÈ¢ò
        Column() {
          Text('Ê†áÈ¢ò')
            .fontSize(14)
            .fontColor('#333333')
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ bottom: 8 })
          
          TextInput({ placeholder: '‰ªäÂ§©Â≠¶‰∫Ü‰ªÄ‰πàÔºü' })
            .width('100%')
            .height(40)
            .fontSize(14)
            .onChange((value: string) => {
              this.newEntryTitle = value
            })
        }
        .width('100%')
        .margin({ bottom: 16 })

        // ÂÜÖÂÆπ
        Column() {
          Text('ÂÜÖÂÆπ')
            .fontSize(14)
            .fontColor('#333333')
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ bottom: 8 })
          
          TextArea({ placeholder: 'ËÆ∞ÂΩï‰ªäÂ§©ÁöÑÂ≠¶‰π†ÂøÉÂæó„ÄÅÈÅáÂà∞ÁöÑÈóÆÈ¢ò„ÄÅÊî∂Ëé∑Á≠â...' })
            .width('100%')
            .height(120)
            .fontSize(14)
            .onChange((value: string) => {
              this.newEntryContent = value
            })
        }
        .width('100%')
        .margin({ bottom: 16 })

        // ÂøÉÊÉÖ
        Column() {
          Text('‰ªäÂ§©ÁöÑÂøÉÊÉÖ')
            .fontSize(14)
            .fontColor('#333333')
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ bottom: 8 })
          
          Row() {
            ForEach(['üòä', 'üéâ', 'üòê', 'üò¥', 'üòî', 'ü§î', 'üò§'], (mood: string) => {
              Column() {
                Text(mood)
                  .fontSize(24)
                
                Text(this.getMoodName(mood))
                  .fontSize(12)
                  .fontColor(this.newEntryMood === mood ? '#007AFF' : '#666666')
                  .margin({ top: 4 })
              }
              .padding(8)
              .backgroundColor(this.newEntryMood === mood ? '#F0F8FF' : 'transparent')
              .borderRadius(8)
              .onClick(() => {
                this.newEntryMood = mood
              })
            }, (mood: string) => mood)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
        }
        .width('100%')
        .margin({ bottom: 16 })

        // Â≠¶‰π†Êï∞ÊçÆ
        Row() {
          Column() {
            Text('Â≠¶‰π†Êó∂Èïø(Â∞èÊó∂)')
              .fontSize(14)
              .fontColor('#333333')
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: '2.5' })
              .width('100%')
              .height(40)
              .fontSize(14)
              .type(InputType.Number)
              .onChange((value: string) => {
                this.newEntryStudyTime = value
              })
          }
          .layoutWeight(1)

          Column() {
            Text('Á≠îÈ¢òÊï∞Èáè')
              .fontSize(14)
              .fontColor('#333333')
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ placeholder: '10' })
              .width('100%')
              .height(40)
              .fontSize(14)
              .type(InputType.Number)
              .onChange((value: string) => {
                this.newEntryQuestions = value
              })
          }
          .layoutWeight(1)
          .margin({ left: 12 })
        }
        .width('100%')
        .margin({ bottom: 20 })

        // Êìç‰ΩúÊåâÈíÆ
        Row() {
          Button('ÂèñÊ∂à')
            .width('45%')
            .height(40)
            .backgroundColor('#F0F0F0')
            .fontColor('#666666')
            .onClick(() => {
              this.showAddEntry = false
              this.resetAddEntryForm()
            })

          Button('‰øùÂ≠ò')
            .width('45%')
            .height(40)
            .backgroundColor('#007AFF')
            .fontColor('#FFFFFF')
            .onClick(() => {
              this.addNewEntry()
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('90%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({ radius: 8, color: '#1A000000', offsetX: 0, offsetY: 4 })
    }
    .width('100%')
    .height('80%')
  }

  @Builder EntryDetailDialog() {
    if (this.selectedEntry) {
      Column() {
      // ÈÅÆÁΩ©Â±Ç
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#80000000')
        .onClick(() => {
          this.showEntryDetail = false
          this.selectedEntry = null
        })
    }
    .width('100%')
    .height('100%')

    // ËØ¶ÊÉÖÂÜÖÂÆπ
    Scroll() {
      Column() {
        Row() {
          Text(this.selectedEntry!.title)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .layoutWeight(1)
          
          Image($r('app.media.ic_close'))
            .width(24)
            .height(24)
            .fillColor('#666666')
            .onClick(() => {
              this.showEntryDetail = false
              this.selectedEntry = null
            })
        }
        .width('100%')
        .margin({ bottom: 16 })

        Text(this.formatDate(this.selectedEntry!.date))
          .fontSize(14)
          .fontColor('#666666')
          .width('100%')
          .textAlign(TextAlign.Start)
          .margin({ bottom: 16 })

        Text(this.selectedEntry!.content)
          .fontSize(16)
          .fontColor('#333333')
          .lineHeight(24)
          .width('100%')
          .textAlign(TextAlign.Start)
          .margin({ bottom: 20 })

        // ÂøÉÊÉÖÂíåÊï∞ÊçÆ
        Column() {
          Row() {
            Text('ÂøÉÊÉÖÔºö')
              .fontSize(14)
              .fontColor('#666666')
            
            Text(this.selectedEntry!.mood)
              .fontSize(20)
              .margin({ left: 8 })
            
            Text(this.getMoodName(this.selectedEntry!.mood))
              .fontSize(14)
              .fontColor('#333333')
              .margin({ left: 4 })
          }
          .width('100%')
          .margin({ bottom: 12 })

          if (this.selectedEntry!.studyTime > 0) {
            Row() {
              Text('Â≠¶‰π†Êó∂ÈïøÔºö')
                .fontSize(14)
                .fontColor('#666666')
              
              Text(`${this.selectedEntry!.studyTime}Â∞èÊó∂`)
                .fontSize(14)
                .fontColor('#007AFF')
                .fontWeight(FontWeight.Medium)
            }
            .width('100%')
            .margin({ bottom: 8 })
          }

          if (this.selectedEntry!.questionsAnswered > 0) {
            Row() {
              Text('Á≠îÈ¢òÊï∞ÈáèÔºö')
                .fontSize(14)
                .fontColor('#666666')
              
              Text(`${this.selectedEntry!.questionsAnswered}ÈÅì`)
                .fontSize(14)
                .fontColor('#4CAF50')
                .fontWeight(FontWeight.Medium)
            }
            .width('100%')
            .margin({ bottom: 8 })
          }

          if (this.selectedEntry!.achievements.length > 0) {
            Row() {
              Text('Ëé∑ÂæóÊàêÂ∞±Ôºö')
                .fontSize(14)
                .fontColor('#666666')
              
              Text(this.selectedEntry!.achievements.join(', '))
                .fontSize(14)
                .fontColor('#FF9800')
                .fontWeight(FontWeight.Medium)
            }
            .width('100%')
          }
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#F8F9FA')
        .borderRadius(8)
      }
      .width('90%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({ radius: 8, color: '#1A000000', offsetX: 0, offsetY: 4 })
    }
    .width('100%')
    .height('80%')
    }
  }
}